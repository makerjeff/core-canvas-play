<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rembound 02</title>

    <script>
        //game.js
        window.onload = function(e) {

            // get canvas and context
            var canvas = document.getElementById('viewport');
            var context = canvas.getContext('2d');
            canvas.imageSmoothingEnabled =false;

            // timing and fps
            var last_frame = 0;
            var fps_time = 0;
            var frame_count = 0;
            var fps = 0;

            // Level properties
            var level = {
                x: 1,
                y: 65,
                width: canvas.width -2,
                height: canvas.height - 66
            };

            // Square
            var square = {
                x: 0,
                y: 0,
                width: 0,
                height: 0,
                xdir: 0,
                ydir: 0,
                speed: 0
            };

            // Score
            var score = 0;

            // initialize game
            function init() {
                //add mouse events
                canvas.addEventListener('mousemove', onMouseMove);
                canvas.addEventListener('mousedown', onMouseDown);
                canvas.addEventListener('mouseup', onMouseUp);
                canvas.addEventListener('mouseout', onMouseOut);

                // Init the square
                square.width = 100;
                square.height = 100;
                square.x = level.x + (level.width - square.width) / 2;
                square.y = level.y + (level.width - square.width) / 2;
                square.xdir = 1;
                square.ydir = 1;
                square.speed = 200;

                // Init the score
                score = 0;

                // enter main loop
                main(0);
            }

            // main loop
            function main(t_frame) {
                // request animation frame
                window.requestAnimationFrame(main);

                update(t_frame);
                render();
            }

            //Update the game state
            function update(t_frame) {
                var dt = (t_frame - last_frame) / 1000;
                last_frame = t_frame;

                // update fps counter
                update_fps(dt);

                // Move the square, time-based
                square.x += dt * square.speed * square.xdir;
                square.y += dt * square.speed * square.ydir;

                // Handle left and right collisions with the level
                if (square.x <= level.x) {
                    //left edge
                    square.xdir = 1;
                    square.x = level.x;
                }
                else if (square.x + square.width >= level.x + level.width) {
                    //right edge
                    square.xdir = -1;
                    square.x = level.x + level.width - square.width;
                }

                // Handle top and bottom collisions with the level
                if (square.y <= level.y) {
                    //top edge
                    square.ydir = 1;
                    square.y = level.y;
                }
                else if (square.y + square.height >= level.y + level.height) {
                    //bottom edge
                    square.ydir = -1;
                    square.y = level.y + level.height - square.height;
                }
            }

            // Update FPS
            function update_fps(dt) {

                if (fps_time > 0.25) {

                    //calculate FPS
                    fps = Math.round(frame_count / fps_time);

                    // reset time and framecount
                    fps_time = 0;
                    frame_count = 0;
                }

                // Increase time and frame count
                fps_time += dt;
                frame_count++;
            }

            // RENDER
            function render() {
                // draw the frame
                drawFrame();

                // draw square
                context.fillStyle = '#ff8080';
                context.fillRect(square.x, square.y, square.width, square.height);

                // draw score inside the square
                context.fillStyle = '#ffffff';
                context.font = '38px Verdana';
                var textdim = context.measureText(score);
                context.fillText(score, square.x + (square.width - textdim.width)/2, square.y + 65);
            }

            // Draw a frame with a border
            function drawFrame() {
                // Draw background and a border
                context.fillStyle = '#d0d0d0';
                context.fillRect(0, 0, canvas.width, canvas.height);
                context.fillStyle = '#e8eaec';
                context.fillRect(1, 1, canvas.width-2, canvas.height-2);

                // draw header
                context.fillStyle = '#303030';
                context.fillRect(0, 0, canvas.width, 65);

                // draw title
                context.fillStyle = '#ffffff';
                context.font = '24px Verdana';
                context.fillText('HTML5 Canvas Basic Framework - Rembound.com', 10, 30);

                // display FPS
                context.fillStyle = '#ffffff';
                context.font = '12px Verdana';
                context.fillText('FPS: ' + fps, 13, 50);
            }

            // MOUSE event handlers
            function onMouseMove(e) {}

            function onMouseDown(e) {
                // get mouse position
                var pos = getMousePos(canvas, e);

                // check if we clicked within the square
                if (pos.x >= square.x && pos.x < square.x + square.width &&
                pos.y >= square.y && pos.y < square.y + square.height) {

                    // increase the score
                    score += 1;

                    // increase the speed of the square by 10 percent
                    square.speed *= 1.1;

                    // give square a random position
                    square.x = Math.floor(Math.random() * (level.x + level.width-square.width));
                    square.y = Math.floor(Math.random() * (level.y + level.height-square.height));

                    // give the square a random direction
                    square.xdir = Math.floor(Math.random() * 2) * 2 - 1;
                    square.ydir = Math.floor(Math.random() * 2) * 2 - 1;

                }
            }
            function onMouseUp(e) {}

            function onMouseOut(e) {}

            // Get mouse position
            function getMousePos(canvas, e) {
                var rect = canvas.getBoundingClientRect();

                return {
                    x: Math.round((e.clientX - rect.left) / (rect.right - rect.left) + canvas.width),
                    y: Math.round((e.clientY - rect.top) / (rect.bottom - rect.top) * canvas.height)
                }
            }

            // call init to start the game
            init();
        }
    </script>
</head>
<body>

<canvas id="viewport" width="640" height="480"></canvas>

<script>
    // http://rembound.com/articles/how-to-make-a-html5-canvas-game
    // HTML5 Canvas Basic Game Framework

</script>
</body>
</html>